# Roadmap v0.3.0: K8s Agent

- **Status**: Idea
- **Created**: 2025-01-12
- **Version**: 0.3.0
- **Prerequisite**: [v0.2.1-agent.md](v0.2.1-agent.md)

---

## 목표

**Control Plane 수정 없이** K8s Agent를 추가하여 Kubernetes 환경을 지원한다.

```
┌─────────────────┐
│  Control Plane  │  ← v0.2.1에서 확정, 수정 없음
│                 │
│  ┌───────────┐  │
│  │  HTTP     │  │
│  │  Client   │  │
│  └─────┬─────┘  │
└────────┼────────┘
         │
         │  동일한 Agent API
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│Docker │ │ K8s   │  ← 새로 추가
│Agent  │ │Agent  │
└───┬───┘ └───┬───┘
    │         │
    ▼         ▼
 Docker    K8s API
 Engine    Server
```

---

## 제약사항

### 네트워크

v0.3.0에서는 Control Plane과 Agent가 **같은 네트워크 망**에 있어야 합니다.

```
Control Plane ────► Agent (직접 HTTP)
```

VPN, FRP 터널 등 다른 네트워크 지원은 v0.4.0+에서 고려합니다.

### API 호환성

v0.2.1에서 확정한 Agent API 계약을 그대로 사용합니다. Control Plane 코드 수정 없이 K8s Agent만 구현합니다.

---

## K8s Runtime 구현

### Instance 관리 (Pod)

| Agent API | K8s 구현 |
|-----------|----------|
| `POST /instances/{id}/start` | Pod 생성 (Deployment 또는 단일 Pod) |
| `DELETE /instances/{id}` | Pod 삭제 |
| `GET /instances/{id}/status` | Pod 상태 조회 |
| `GET /instances/{id}/upstream` | Service ClusterIP/Port 반환 |

### Volume 관리 (PVC)

| Agent API | K8s 구현 |
|-----------|----------|
| `POST /volumes/{id}` | PVC 생성 |
| `DELETE /volumes/{id}` | PVC 삭제 |
| `GET /volumes/{id}/exists` | PVC 존재 확인 |

### Job 실행 (K8s Job)

| Agent API | K8s 구현 |
|-----------|----------|
| `POST /jobs/archive` | K8s Job (archive container) |
| `POST /jobs/restore` | K8s Job (restore container) |

---

## 프로젝트 구조

v0.2.1에서 생성한 `codehub_agent` 패키지에 K8s Runtime 추가:

```
src/codehub_agent/
├── runtimes/
│   ├── docker/       # v0.2.1에서 구현
│   └── k8s/          # v0.3.0에서 추가
│       ├── __init__.py
│       ├── instance.py   # Pod 관리
│       ├── volume.py     # PVC 관리
│       └── job.py        # K8s Job 관리
```

---

## 마일스톤

### Phase 1: K8s Runtime 구현
- [ ] K8s Runtime 구현 (Pod, PVC 관리)
- [ ] K8s용 StorageClass/PVC 설정
- [ ] K8s Job 구현 (archive/restore)

### Phase 2: 배포
- [ ] K8s 배포 매니페스트 (Helm Chart)
- [ ] Agent Deployment/Service
- [ ] RBAC 설정

### Phase 3: 테스트
- [ ] E2E 테스트 (minikube/kind)
- [ ] Docker + K8s 혼합 환경 테스트
- [ ] 장애 복구 시나리오 테스트
- [ ] 문서화

---

## Open Questions

- [ ] Pod vs Deployment 선택 기준?
- [ ] StorageClass 설정 방법?
- [ ] K8s namespace 전략?
- [ ] Agent Pod 리소스 제한?

---

## References

- 이전 버전: [v0.2.1-agent.md](v0.2.1-agent.md)
- K8s Python Client: https://github.com/kubernetes-client/python
