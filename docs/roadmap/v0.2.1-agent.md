# Roadmap v0.2.1: Control Plane + Agent 아키텍처

- **Status**: Idea
- **Created**: 2025-01-12
- **Updated**: 2025-01-13
- **Version**: 0.2.1
- **License**: AGPL-3.0 (이 버전부터 변경)

---

## 1. 핵심 철학

### BYOC (Bring Your Own Cluster) + BYOS (Bring Your Own Storage)

```
Control Plane = 메타데이터/오케스트레이션만 (데이터 비소유)
Agent = 모든 실제 자원 관리 (컨테이너, 볼륨, S3)
```

**Control Plane은 사용자 데이터를 소유하거나 저장하지 않습니다.**

사용자가 자신의 인프라(Docker, K8s, S3/MinIO)를 가져오고, Control Plane은 오케스트레이션만 담당합니다.

---

## 2. 아키텍처

### Control Plane vs Agent 역할 분리

```
┌─────────────────────────────────────────────────────────────┐
│                 Control Plane (Stateful, DB 있음)           │
│                                                             │
│  1. 스케줄링 (Scheduler)                                    │
│     - 클러스터 선택/배치 결정                               │
│                                                             │
│  2. 오케스트레이션 (Reconciler)                             │
│     - 상태 머신 관리 (Phase)                                │
│     - desired vs actual 맞추기                             │
│     - 시작/정지/아카이브 "명령"                             │
│                                                             │
│  3. 자동화 (TTL Manager)                                    │
│     - Idle 감지 → 정지 명령                                │
│     - TTL 만료 → 아카이브 명령                             │
│     - 접속 시 → 시작 명령                                  │
│                                                             │
│  4. 프록시 (Proxy)                                          │
│     - 단일 진입점                                           │
│     - 라우팅                                                │
│                                                             │
│  5. 인증/인가 (Auth)                                        │
│     - 사용자 관리                                           │
│     - 권한 체크                                             │
│                                                             │
│  6. 메타데이터 (DB)                                         │
│     - 상태 저장                                             │
│     - 클러스터/워크스페이스 정보                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ 명령 (HTTP)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   Agent (Stateless, DB 없음)                │
│                                                             │
│  실행만:                                                    │
│  - Instance 관리 (컨테이너/Pod 생성/삭제)                  │
│  - Volume 관리 (Docker Volume/PVC)                         │
│  - Job 실행 (archive/restore)                              │
│  - Storage 관리 (S3/MinIO 업로드/다운로드)                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
    ┌────────┐       ┌────────┐        ┌────────┐
    │ Docker │       │  K8s   │        │S3/MinIO│
    │ Engine │       │  API   │        │        │
    └────────┘       └────────┘        └────────┘

    (전부 사용자 소유 인프라)
```

### Control Plane의 가치

| 가치 | 설명 |
|------|------|
| 오케스트레이션 | 여러 클러스터를 하나의 UI로 통합 관리 |
| 자동화 | Idle 감지 → 정지, TTL → 아카이브, 접속 → 시작 |
| 스케줄링 | 클러스터 선택, 리소스 밸런싱 |
| 프록시 | 단일 진입점, NAT 뒤에서도 접근 (SaaS) |
| 상태 관리 | Phase 상태 머신, 장애 복구, 히스토리 |

**Agent만으로는 불가능한 것**:
- Agent는 Stateless (DB 없음)
- 통합 관리, 자동화, 히스토리, 여러 클러스터 연동 불가

---

## 3. DB 스키마 설계

### 설계 원칙

- **workspaces 테이블 수정 안 함** (완결된 테이블)
- **별도 테이블로 관계 표현** (역할 분리)
- **SaaS 확장은 별도 테이블** (Space 등)

### 테이블 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 영역 (기존)                        │
│   users, sessions                                               │
└─────────────────────────────────────────────────────────────────┘
         │
         │ owner_user_id
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    워크스페이스 영역 (기존, 수정 없음)            │
│   workspaces (id, owner_user_id, name, phase, ...)              │
└─────────────────────────────────────────────────────────────────┘
         │
         │ workspace_id (1:1)
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                        배치 영역 (신규)                          │
│   workspace_placements (workspace_id PK, cluster_id)            │
└─────────────────────────────────────────────────────────────────┘
         │
         │ cluster_id (N:1)
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      클러스터 영역 (신규)                         │
│   clusters (id, name, type, endpoint, status, ...)              │
│   cluster_members (cluster_id, user_id, role)                   │
└─────────────────────────────────────────────────────────────────┘
```

### 상세 스키마

```sql
-- ============================================
-- 1. 클러스터 테이블 (신규)
-- ============================================
CREATE TABLE clusters (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,              -- 'docker', 'k8s'
    endpoint VARCHAR(512) NOT NULL,         -- 'http://localhost:8080'
    api_key_hash VARCHAR(255),
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    last_health_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_clusters_status ON clusters(status);

-- ============================================
-- 2. 클러스터 멤버 테이블 (신규)
-- ============================================
CREATE TABLE cluster_members (
    cluster_id UUID NOT NULL REFERENCES clusters(id) ON DELETE CASCADE,
    user_id VARCHAR(26) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(50) NOT NULL,              -- 'owner', 'member'
    granted_by VARCHAR(26) REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (cluster_id, user_id)
);

CREATE INDEX idx_cluster_members_user ON cluster_members(user_id);

-- ============================================
-- 3. 워크스페이스 배치 테이블 (신규)
-- ============================================
CREATE TABLE workspace_placements (
    workspace_id VARCHAR(26) PRIMARY KEY REFERENCES workspaces(id) ON DELETE CASCADE,
    cluster_id UUID NOT NULL REFERENCES clusters(id) ON DELETE RESTRICT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_workspace_placements_cluster ON workspace_placements(cluster_id);
```

### 권한 규칙

| 행위 | 조건 |
|------|------|
| Cluster 등록 | 로그인한 사용자 |
| Cluster 삭제 | owner만, workspace 없어야 함 (RESTRICT) |
| Grant 부여/회수 | owner만 |
| Workspace 생성 | cluster owner OR member |
| Workspace 접근 | workspace owner만 |

**핵심**: 클러스터 공유 ≠ 워크스페이스 공유

---

## 4. Agent API

```
# Instance
POST   /instances/{workspace_id}/start    → 컨테이너 시작
DELETE /instances/{workspace_id}          → 컨테이너 삭제
GET    /instances/{workspace_id}/status   → 상태 조회
GET    /instances/{workspace_id}/upstream → 프록시 주소

# Volume
POST   /volumes/{workspace_id}            → 볼륨 생성
DELETE /volumes/{workspace_id}            → 볼륨 삭제
GET    /volumes/{workspace_id}/exists     → 존재 확인

# Job
POST   /jobs/archive                      → 아카이브 Job
POST   /jobs/restore                      → 복원 Job

# Storage
POST   /storage/upload                    → S3 업로드
GET    /storage/download                  → S3 다운로드
DELETE /storage/{key}                     → S3 삭제

# Health
GET    /health                            → Agent 상태
```

---

## 5. Control Plane 코드 변경

### adapters/ 정리

```
현재:
src/codehub/adapters/
├── instance/      → Agent로 이동
├── volume/        → Agent로 이동
├── job/           → Agent로 이동
└── storage/       → Agent로 이동

변경 후:
src/codehub/
├── adapters/      → 삭제 또는 비움
└── agent/
    └── client.py  → AgentClient (HTTP 호출)
```

### 흐름 변경

```
현재:
  Reconciler → DockerInstanceController → Docker API

변경 후:
  Reconciler → AgentClient → Agent → Docker API
```

---

## 6. 오픈소스/SaaS 분리

### 현재 리포 (v0.2.1부터 AGPL-3.0)

```
code-hub/ (오픈소스, AGPL-3.0)
├── Control Plane (기본 기능)
├── Agent
└── Self-hosted용
```

### SaaS (별도 클로즈드 리포)

```
codehub-saas/ (클로즈드)
├── code-hub를 import
├── Space, 협업 (별도 테이블)
├── NAT 터널링
├── 빌링
└── SaaS main.py (확장된 FastAPI app)
```

### DB 분리

- **오픈소스**: users, workspaces, clusters, cluster_members, workspace_placements
- **SaaS 전용**: spaces, space_members, billing (별도 테이블, 같은 DB)

---

## 7. 마이그레이션 전략

```
v0.2.0 → v0.2.1:

1. 라이센스 변경 (Apache 2.0 → AGPL-3.0)

2. 새 테이블 생성 (clusters, cluster_members, workspace_placements)

3. 기존 workspace:
   - placement 없음 → instance_backend로 fallback (로컬 Docker)

4. 신규 workspace:
   - 클러스터 선택 필수
   - workspace_placements에 배치 정보 저장
```

---

## 8. 마일스톤

### Phase 1: 인프라 준비

- [ ] 라이센스 AGPL-3.0 변경
- [ ] clusters, cluster_members, workspace_placements 테이블 마이그레이션
- [ ] Cluster 도메인 모델 및 서비스

### Phase 2: Agent 구현

- [ ] codehub_agent 패키지 생성
- [ ] Docker Runtime 구현 (기존 adapters/ 코드 이전)
- [ ] Storage Runtime 구현 (S3/MinIO)
- [ ] Agent API 엔드포인트

### Phase 3: Control Plane 리팩토링

- [ ] AgentClient 구현 (HTTP 호출)
- [ ] 기존 adapters/ 제거
- [ ] Reconciler → AgentClient 연결
- [ ] Cluster 등록/관리 API

### Phase 4: 통합 및 배포

- [ ] docker-compose 업데이트 (Control Plane + Agent)
- [ ] E2E 테스트
- [ ] 문서화

---

## 9. Open Questions

- [ ] Agent Health Check 주기? (제안: 30초)
- [ ] Agent 타임아웃? (제안: 30초)
- [ ] Workspace 생성 시 cluster 자동 선택 로직?

---

## References

- 현재 구현: `src/codehub/adapters/`
- 인터페이스: `src/codehub/core/interfaces/`
- 다음 버전: [v0.3.0-k8s.md](v0.3.0-k8s.md)
