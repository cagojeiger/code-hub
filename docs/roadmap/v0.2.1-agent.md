# Roadmap v0.2.1: Runtime Agent API

- **Status**: Idea
- **Created**: 2025-01-12
- **Version**: 0.2.1

---

## 목표

Control Plane + Docker Agent 기반 아키텍처로 리팩토링하여 **Agent API 계약을 확정**한다.

```
v0.2.0 (현재)                    v0.2.1 (목표)
┌─────────────────┐             ┌─────────────────┐
│  Control Plane  │             │  Control Plane  │
│                 │             │                 │
│  ┌───────────┐  │             │  ┌───────────┐  │
│  │ docker-py │──┼──► Docker   │  │  HTTP     │  │
│  └───────────┘  │             │  │  Client   │  │
└─────────────────┘             │  └─────┬─────┘  │
                                └────────┼────────┘
                                         │
                                         ▼
                                    ┌───────┐
                                    │Docker │
                                    │Agent  │──► Docker
                                    └───────┘
```

**핵심 원칙**: v0.2.1에서 확정한 Agent API 계약은 v0.3.0 (K8s Agent)에서 그대로 사용한다.

---

## 1. 문제: 직접 호출의 한계

현재 Control Plane이 Docker를 직접 호출합니다:

```python
if backend == "docker":
    docker-py 호출
elif backend == "k8s":
    kubernetes-client 호출  # 추가할 때마다 분기 증가
```

**문제점:**
- 백엔드마다 Control Plane 코드 수정 필요
- 테스트 복잡도 증가
- 관심사가 섞임

---

## 2. 해결: Agent 레이어 도입

모든 백엔드를 **Runtime Agent**로 감싸고, **동일한 HTTP 프로토콜**로 통신합니다.

**Control Plane 입장에서 모든 Agent가 똑같이 생겼습니다.**

---

## 3. 아키텍처 결정

| 항목 | 결정 |
|------|------|
| 배포 형태 | 독립 서비스 (docker-compose로 함께 배포) |
| 인증 방식 | API Key (환경변수 전달) |
| Agent 등록 | DB 등록 (동적 관리) |
| Workspace 할당 | 1 Agent = 1 Cluster |
| 장애 처리 | Health Check + Retry |

---

## 4. Agent API 스펙

### 4.1 Instance 관리

```
POST   /instances/{workspace_id}/start     - 컨테이너 시작
DELETE /instances/{workspace_id}           - 컨테이너 삭제
GET    /instances/{workspace_id}/status    - 상태 확인
GET    /instances/{workspace_id}/upstream  - 프록시 주소 반환
GET    /instances                          - 전체 목록 (prefix 필터)
```

### 4.2 Volume 관리

```
POST   /volumes/{workspace_id}             - 볼륨 생성
DELETE /volumes/{workspace_id}             - 볼륨 삭제
GET    /volumes/{workspace_id}/exists      - 존재 확인
GET    /volumes                            - 전체 목록
```

### 4.3 Job 실행

```
POST   /jobs/archive                       - 아카이브 Job 실행
POST   /jobs/restore                       - 복원 Job 실행
```

### 4.4 Health

```
GET    /health                             - Agent 상태
```

---

## 5. DB 스키마 확장

### 5.1 agents 테이블

```sql
CREATE TABLE agents (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    endpoint VARCHAR(255) NOT NULL,      -- https://agent.example.com
    api_key_hash VARCHAR(255) NOT NULL,  -- bcrypt hash
    type VARCHAR(50) NOT NULL,           -- docker, k8s
    status VARCHAR(50) DEFAULT 'active', -- active, inactive, error
    capacity INT,                        -- 최대 workspace 수
    current_load INT DEFAULT 0,          -- 현재 workspace 수
    region VARCHAR(100),                 -- ap-northeast-2
    labels JSONB,                        -- 추가 메타데이터
    last_health_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 5.2 workspaces 테이블 수정

```sql
ALTER TABLE workspaces ADD COLUMN agent_id UUID REFERENCES agents(id);
```

---

## 6. 프로젝트 구조

모노레포 내 패키지로 구성:

```
code-hub/
├── src/
│   ├── codehub/              # Control Plane
│   └── codehub_agent/        # Runtime Agent 패키지
│       ├── __init__.py
│       ├── app/
│       │   ├── main.py       # FastAPI app
│       │   ├── api/
│       │   │   ├── instances.py
│       │   │   ├── volumes.py
│       │   │   ├── jobs.py
│       │   │   └── health.py
│       │   └── config.py
│       ├── runtimes/
│       │   └── docker/       # Docker Runtime 구현
│       └── core/
│           └── interfaces.py
├── containers/
│   ├── storage-job/          # 기존
│   └── agent/                # Runtime Agent Dockerfile
│       └── Dockerfile
└── pyproject.toml            # uv workspace 설정
```

---

## 7. 마일스톤

### Phase 1: Agent API 설계
- [ ] Runtime Agent API 인터페이스 정의
- [ ] OpenAPI 스펙 작성
- [ ] API 계약 문서화

### Phase 2: 인프라 변경
- [ ] agents 테이블 추가
- [ ] workspaces.agent_id 컬럼 추가
- [ ] DB 마이그레이션

### Phase 3: Agent 구현
- [ ] codehub-agent 패키지 생성
- [ ] Docker Runtime 구현 (기존 코드 이전)
- [ ] Agent Health 엔드포인트

### Phase 4: Control Plane 리팩토링
- [ ] Control Plane → Agent HTTP Client 구현
- [ ] 기존 직접 호출 코드 제거
- [ ] Agent 등록/관리 API

### Phase 5: 배포
- [ ] docker-compose 업데이트 (Control Plane + Docker Agent)
- [ ] E2E 테스트
- [ ] 문서화

---

## 8. 핵심 가치

| 가치 | 설명 |
|------|------|
| 확장성 | 새 백엔드 = 새 Agent만 구현, Control Plane 수정 불필요 |
| 단순성 | Control Plane이 백엔드 구현을 몰라도 됨, HTTP 통신만 |
| 격리 | Agent 장애가 다른 클러스터에 영향 없음 |
| 테스트 | Mock Agent로 Control Plane 테스트 가능 |

---

## 9. 고려사항

| 항목 | 내용 |
|------|------|
| 추가 컴포넌트 | Docker Agent가 별도 서비스로 분리됨, 관리 포인트 증가 |
| 네트워크 홉 | +1 홉 추가, 약간의 지연 (~1-5ms 로컬 환경) |
| 보안 설정 | API Key 관리 필요, 향후 mTLS 검토 |

---

## 10. Open Questions

- [ ] Agent Health Check 주기는? (제안: 30초)
- [ ] Agent 타임아웃은? (제안: 30초)
- [ ] Workspace 생성 시 agent_id 자동 할당 로직?

---

## References

- 현재 구현: `src/codehub/adapters/instance/`
- 인터페이스: `src/codehub/core/interfaces/`
- 다음 버전: [v0.3.0-k8s.md](v0.3.0-k8s.md)
